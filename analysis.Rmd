---
title: "Analysis on Health and Economic Effects of Severe Weather Events"
author: "Daniel DeWaters"
date: "10/14/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

# Load dependencies
#install.packages("R.utils") ###########
library(R.utils)
library(plyr)
library(dplyr)
library(reshape2)
library(ggplot2)
```


## Data Pre-processing

I start by downloading the data file, unzipping it, and reading it in using read.csv().

```{r getData}
data_url <- "https://d396qusza40orc.cloudfront.net/repdata%2Fdata%2FStormData.csv.bz2"
data_file_name <- "./data/repdata_data_StormData.csv.bz2"
unzipped_file_name <- "./data/repdata_data_StormData.csv"

if(!file.exists(unzipped_file_name)){
  download.file(data_url, destfile=data_file_name, method="curl")
  bunzip2(data_file_name, destname=unzipped_file_name, remove=FALSE, overwrite=TRUE)
}

raw_data <- read.csv(unzipped_file_name)
```

Cleaning the dataset is quite a lengthy process. There are a lot of different EVTYPE entries for the same type of weather event but use different phrasing or have abreviations or spelling errors. This part of the preprocessing aims to group together as many of these event types as possible. This chunk also processes the property and crop damage columns by replacing the PROPDMGEXP and PROPDMGEXP with their respective exponent and multiplying the PROPDMG and CROPDMG columns by 10 to the power of their corresponding exponents.

```{r cleandata}
clean_data <- 
  raw_data %>%
  
  ## Clean EVTYPE columns
  mutate(EVTYPE = tolower(EVTYPE)) %>%
  # Remove forward slashes and numbers at the end of types
  mutate(EVTYPE = gsub("/", " ", EVTYPE)) %>%
  mutate(EVTYPE = gsub(".\\d+$", "", EVTYPE)) %>%
  # Combine thunderstorm word variants
  mutate(EVTYPE = gsub("tstm", "thunderstorm", EVTYPE)) %>%
  mutate(EVTYPE = gsub("(.*)^thu(.*) *", "thunderstorm", EVTYPE)) %>%
  mutate(EVTYPE = gsub("thunderstorms", "thunderstorm", EVTYPE)) %>%
  mutate(EVTYPE = gsub("(.*)thunderstorm wind(.*)", "thunderstorm wind", EVTYPE)) %>%
  mutate(EVTYPE = gsub("\\d+ mph", "", EVTYPE)) %>%
  # Fix "wind" variants
  mutate(EVTYPE = gsub("wnd", "wind", EVTYPE)) %>%
  mutate(EVTYPE = gsub("winds", "wind", EVTYPE)) %>%
  # Combine all types about flooding, hurricanes, wind, landslide, hail, snow, and fire
  mutate(EVTYPE = gsub("fld", "flood", EVTYPE)) %>%
  mutate(EVTYPE = gsub("(.*)flood(.*)", "flood", EVTYPE)) %>%
  mutate(EVTYPE = gsub("(.*)surf(.*)", "heavy surf", EVTYPE)) %>%
  mutate(EVTYPE = gsub("(.*)hurricane(.*)", "hurricane", EVTYPE)) %>%
  mutate(EVTYPE = gsub("(.*)tropical storm(.*)", "tropical storm", EVTYPE)) %>%
  mutate(EVTYPE = gsub("(.*)high wind(.*)", "high wind", EVTYPE)) %>%
  mutate(EVTYPE = gsub("(.*)land(.*)", "landslide", EVTYPE)) %>%
  mutate(EVTYPE = gsub("(.*)slide(.*)", "landslide", EVTYPE)) %>%
  mutate(EVTYPE = gsub("(.*)water *spout(.*)", "waterspout", EVTYPE)) %>%
  mutate(EVTYPE = gsub("(.*)wind *chill(.*)", "wind chill", EVTYPE)) %>%
  mutate(EVTYPE = gsub("(.*)hail(.*)", "hail", EVTYPE)) %>%
  mutate(EVTYPE = gsub("(.*)snow(.*)", "snow", EVTYPE)) %>%
  mutate(EVTYPE = gsub("(.*)fire(.*)", "wildfire", EVTYPE)) %>%
  # Fix "tornado" misspellings
  mutate(EVTYPE = gsub("(.*)torn(.*)", "tornado", EVTYPE)) %>%
  # Other
  mutate(EVTYPE = gsub("unseason(.*) ", "unseasonal ", EVTYPE)) %>%
  filter(!grepl("summary", EVTYPE)) %>%

    ## Clean property and crop damage and exponents columns
  mutate(PROPDMGEXP = tolower(PROPDMGEXP)) %>%
  mutate(CROPDMGEXP = tolower(CROPDMGEXP)) %>%
  # Replace exponent characters with the corresponding number
  mutate(PROPDMGEXP = revalue(PROPDMGEXP, replace=c("-"="0", "?"="0", "+"="1", "h"="2", "k"="3", "m"="6", "b"="9"))) %>%
  mutate(CROPDMGEXP = revalue(CROPDMGEXP, replace=c("?"="0", "k"="3", "m"="6", "b"="9"))) %>%
  # revalue doesn't replace blank strings so I had to do it this way
  mutate(PROPDMGEXP = gsub("^$", "0", PROPDMGEXP)) %>%
  mutate(CROPDMGEXP = gsub("^$", "0", CROPDMGEXP)) %>%
  # Convert exponents to numeric
  mutate(PROPDMGEXP = as.numeric(PROPDMGEXP)) %>%
  mutate(CROPDMGEXP = as.numeric(CROPDMGEXP)) %>%
  # multiply damage and exponent columns to get full damages
  mutate(propertydamage = PROPDMG * (10^PROPDMGEXP)) %>%
  mutate(cropdamage = CROPDMG * (10^CROPDMGEXP))
  

# Filter by event types that have more than 10 records in the dataset
ev_type_counts <- sort(table(clean_data$EVTYPE), decreasing=TRUE)
ev_df <- as.data.frame(ev_type_counts, stringsAsFactors=FALSE); names(ev_df) <- c("type", "freq")
top_counts <- filter(ev_df, freq >= 10)

data <- filter(clean_data, EVTYPE %in% top_counts$type)
```

```{r calculations}

## Get the average and total property/crop damage for each event type, then the average and total deaths and injuries for each event type
data_means <-
  data %>%
  group_by(EVTYPE) %>%
  summarise(sum_prop_dmg = sum(propertydamage, na.rm=TRUE),
            sum_crop_dmg = sum(cropdamage, na.rm=TRUE),
            total_dmg = sum_prop_dmg + sum_crop_dmg,
            sum_injuries = sum(INJURIES, na.rm = TRUE),
            sum_fatalities = sum(FATALITIES, na.rm=TRUE))



## Get the top 10 highest-costing weather event types for total and average property and crop damages
top_total_dmg <-
  data_means %>%
  # Select columns that we want to plot
  select(EVTYPE, total_dmg, sum_prop_dmg, sum_crop_dmg) %>%
  # Sort by the top 10 highest total costs
  arrange(desc(total_dmg)) %>%
  top_n(10) %>%
  # Change column names for ease of plotting
  rename("Property"="sum_prop_dmg", "Crop"="sum_crop_dmg") %>%
  # Remove total_dmg column for ease of plotting
  select(EVTYPE, Property, Crop)

# Melt data frame into narrow form for ease of plotting
top_dmg <- melt(top_total_dmg,
            id.vars="EVTYPE", measure.vars=c("Property", "Crop"),
            value.name = "cost", measure.name="Damge")

# Makes ggplot2 plot the barplots in decreasing order
dmg_order <- top_total_dmg$EVTYPE
top_dmg$EVTYPE <- factor(top_dmg$EVTYPE, levels=dmg_order)



## Get the top 10 highest fatal and injuring weather event types
top_fatal <- 
  data_means %>%
  select(EVTYPE, sum_fatalities) %>%
  arrange(desc(sum_fatalities)) %>%
  top_n(10) %>%
  rename("Fatalities"="sum_fatalities")

top_injury <- 
  data_means %>%
  select(EVTYPE, sum_injuries) %>%
  arrange(desc(sum_injuries)) %>%
  top_n(10) %>%
  rename("Injuries"="sum_injuries")
```

## Results
```{r plots}
dmg_plot <- ggplot(top_dmg, aes(fill=variable, x=EVTYPE, y=cost))
dmg_plot + geom_bar(position="stack", stat="identity") +
  xlab("Weather Event Type") + ylab("Damage Costs (In US Dollars)") +
  ggtitle("10 Highest Property and Crop Damaging Weather Events")

fatal_plot <- ggplot(top_fatal, aes(x=reorder(EVTYPE, -Fatalities), y=Fatalities))
fatal_plot + geom_bar(stat="identity") +
  xlab("Weather Event Type") + ylab("Total Number of Fatalities") +
  ggtitle("10 Most Fatal Weather Events")

injury_plot <- ggplot(top_injury, aes(x=reorder(EVTYPE, -Injuries), y=Injuries))
injury_plot + geom_bar(stat="identity") +
  xlab("Weather Event Type") + ylab("Total Number of Injuries") +
  ggtitle("10 Most Injury-Causing Weather Events")
```
